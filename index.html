<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Civilization I – Tech Prerequisite Explorer</title>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <style>
      :root {
        --bg: #0f172a;
        --panel: #111827;
        --muted: #94a3b8;
        --text: #e5e7eb;
        --accent: #38bdf8;
        --unit-color: #fbbf24;
        --building-color: #34d399;
        --wonder-color: #a78bfa;
        --other-color: #f87171;
      }
      html,
      body {
        margin: 0;
        padding: 0;
        height: 100%;
        font-family: system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial, Helvetica, sans-serif;
        background: var(--bg);
        color: var(--text);
      }
      .wrap {
        max-width: 900px;
        margin: 40px auto;
        padding: 24px;
        background: linear-gradient(180deg, rgba(255, 255, 255, 0.04), rgba(255, 255, 255, 0.02));
        border: 1px solid rgba(255, 255, 255, 0.08);
        border-radius: 16px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.25);
      }
      h1 {
        margin: 0 0 12px;
        font-size: 24px;
        letter-spacing: 0.3px;
      }
      p {
        margin: 0 0 16px;
        color: var(--muted);
      }
      select,
      input[type="text"] {
        width: 100%;
        padding: 12px 14px;
        border-radius: 12px;
        border: 1px solid rgba(255, 255, 255, 0.15);
        background: #0b1220;
        color: var(--text);
      }
      .row {
        display: grid;
        gap: 14px;
        grid-template-columns: 1fr;
      }
      @media (min-width: 720px) {
        .row {
          grid-template-columns: 1fr 1fr;
        }
      }
      .panel {
        padding: 16px;
        background: #0b1220;
        border: 1px solid rgba(255, 255, 255, 0.08);
        border-radius: 12px;
      }
      .muted {
        color: var(--muted);
      }
      .chips {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
      }
      .chip {
        padding: 6px 10px;
        border-radius: 999px;
        border: 1px solid rgba(255, 255, 255, 0.15);
        background: #0f172a;
        font-size: 13px;
      }
      .list {
        margin-top: 10px;
      }
      .list li {
        margin: 6px 0;
        padding: 8px 10px;
        border-radius: 8px;
        background: #0f172a;
        border: 1px solid rgba(255, 255, 255, 0.08);
      }
      .small {
        font-size: 12px;
      }
      .accent {
        color: var(--accent);
      }
      .allows-chip {
        font-size: 11px;
        padding: 2px 6px;
        border-radius: 4px;
        margin-left: 8px;
        font-weight: 500;
      }
      .allows-unit {
        background: #fbbf24;
        color: #000;
      }
      .allows-building {
        background: #34d399;
        color: #000;
      }
      .allows-wonder {
        background: #a78bfa;
        color: #000;
      }
      .allows-other {
        background: #f87171;
        color: #000;
      }
      .allows-list {
        margin-top: 4px;
        font-size: 11px;
        color: var(--muted);
      }
      .footer {
        margin-top: 20px;
        font-size: 12px;
        color: var(--muted);
      }
      .inline-code {
        padding: 0.1em 0.4em;
        border-radius: 6px;
        background: #0b1220;
        border: 1px solid rgba(255, 255, 255, 0.08);
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      }

      /* SortableJS visual feedback */
      .sortable-ghost {
        opacity: 0.4;
        background: rgba(56, 189, 248, 0.1) !important;
      }

      .sortable-chosen {
        background: rgba(56, 189, 248, 0.2) !important;
      }

      .sortable-drag {
        opacity: 0.8;
        transform: rotate(5deg);
      }

      .no-drag {
        cursor: default !important;
      }
    </style>
  </head>
  <body>
    <div class="wrap">
      <h1>Sid Meier’s Civilization I – Tech Prerequisite Explorer</h1>
      <p>Select a technology to see the prerequisite chain you need (in order). Data is encoded in a simple JS object (<span class="inline-code">{ [tech]: [req1, req2] }</span>).</p>

      <div class="row">
        <div class="panel">
          <label for="search" class="muted small">Filter technologies</label>
          <input id="search" type="text" placeholder="Type to filter… (e.g. 'Flight')" oninput="filterOptions()" />
          <div style="height: 10px"></div>
          <label for="tech" class="muted small">Choose a technology</label>
          <select id="tech" size="12" onchange="render()"></select>

          <!-- Saved Lists Section -->
          <div style="margin-top: 20px; padding-top: 16px; border-top: 1px solid rgba(255, 255, 255, 0.08)">
            <div id="savedLists" style="margin-top: 12px">
              <!-- Saved lists will appear here -->
            </div>
          </div>
        </div>

        <div class="panel">
          <!-- Save Button at Top -->
          <div style="display: flex; gap: 8px; margin-bottom: 16px; padding: 12px; background: rgba(56, 189, 248, 0.1); border: 1px solid rgba(56, 189, 248, 0.2); border-radius: 8px">
            <input
              id="saveNameTop"
              type="text"
              placeholder="Save this list as..."
              style="flex: 1; padding: 8px 12px; border-radius: 6px; border: 1px solid rgba(255, 255, 255, 0.15); background: #0b1220; color: var(--text); font-size: 13px"
            />
            <button
              id="saveBtnTop"
              onclick="saveCurrentListFromTop()"
              style="padding: 8px 16px; border-radius: 6px; border: 1px solid var(--accent); background: var(--accent); color: #000; font-weight: 500; cursor: pointer; font-size: 13px"
            >
              Save List
            </button>
          </div>

          <div class="chips" id="summary"></div>

          <!-- Reorderable List Section -->
          <div style="margin-top: 16px">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px">
              <label class="muted small">Research Order (drag to reorder)</label>
              <button
                id="resetOrderBtn"
                onclick="resetToOriginalOrder()"
                style="padding: 4px 8px; border-radius: 4px; border: 1px solid var(--muted); background: transparent; color: var(--muted); font-size: 11px; cursor: pointer"
              >
                Reset Order
              </button>
            </div>
            <ol class="list" id="chain" style="cursor: grab"></ol>
          </div>

          <div id="notes" class="footer"></div>
        </div>
      </div>
    </div>

    <script>
      // --- Unified data structure: tech -> { prereqs: [], allows: {} } ---
      // Source: Civilization Wiki - https://civilization.fandom.com/wiki/List_of_advances_in_Civ1
      const advances = {
        "Advanced Flight": {
          prereqs: ["Flight", "Electricity"],
          allows: { units: ["Bomber", "Carrier"] },
        },
        Alphabet: {
          prereqs: [],
          allows: {},
        },
        Astronomy: {
          prereqs: ["Mysticism", "Mathematics"],
          allows: { wonders: ["Copernicus' Observatory"] },
        },
        "Atomic Theory": {
          prereqs: ["Theory of Gravity", "Physics"],
          allows: {},
        },
        Automobile: {
          prereqs: ["Combustion", "Steel"],
          allows: { units: ["Armor"] },
        },
        Banking: {
          prereqs: ["Trade", "The Republic"],
          allows: { buildings: ["Bank"] },
        },
        "Bridge Building": {
          prereqs: ["Iron Working", "Alphabet"],
          allows: { other: ["Road on river squares"] },
        },
        "Bronze Working": {
          prereqs: [],
          allows: { units: ["Phalanx"], wonders: ["Colossus"] },
        },
        "Ceremonial Burial": {
          prereqs: [],
          allows: { buildings: ["Temple"] },
        },
        Chemistry: {
          prereqs: ["University", "Medicine"],
          allows: {},
        },
        Chivalry: {
          prereqs: ["Feudalism", "Horseback Riding"],
          allows: { units: ["Knights"] },
        },
        "Code of Laws": {
          prereqs: ["Alphabet"],
          allows: { buildings: ["Courthouse"] },
        },
        Combustion: {
          prereqs: ["Refining", "Explosives"],
          allows: { units: ["Cruiser"] },
        },
        Communism: {
          prereqs: ["Philosophy", "Industrialization"],
          allows: { other: ["Communism"], wonders: ["United Nations"] },
        },
        Computers: {
          prereqs: ["Mathematics", "Electronics"],
          allows: { wonders: ["SETI Program"] },
        },
        Conscription: {
          prereqs: ["The Republic", "Explosives"],
          allows: { units: ["Riflemen"] },
        },
        Construction: {
          prereqs: ["Masonry", "Currency"],
          allows: { other: ["Fortress"], buildings: ["Aqueduct", "Colosseum"] },
        },
        "The Corporation": {
          prereqs: ["Banking", "Industrialization"],
          allows: {},
        },
        Currency: {
          prereqs: ["Bronze Working"],
          allows: { buildings: ["Marketplace"] },
        },
        Democracy: {
          prereqs: ["Philosophy", "Literacy"],
          allows: { other: ["Democracy"] },
        },
        Electricity: {
          prereqs: ["Magnetism", "Metallurgy"],
          allows: {},
        },
        Electronics: {
          prereqs: ["Electricity", "Engineering"],
          allows: { buildings: ["Hydro Plant"], wonders: ["Hoover Dam"] },
        },
        Engineering: {
          prereqs: ["The Wheel", "Construction"],
          allows: {},
        },
        Explosives: {
          prereqs: ["Gunpowder", "Chemistry"],
          allows: {},
        },
        Feudalism: {
          prereqs: ["Masonry", "Monarchy"],
          allows: {},
        },
        Flight: {
          prereqs: ["Combustion", "Physics"],
          allows: { units: ["Fighter"] },
        },
        "Fusion Power": {
          prereqs: ["Nuclear Power", "Superconductor"],
          allows: {},
        },
        "Future Tech": {
          prereqs: ["Fusion Power"],
          allows: {},
        },
        "Genetic Engineering": {
          prereqs: ["Medicine", "The Corporation"],
          allows: { wonders: ["Cure for Cancer"] },
        },
        Gunpowder: {
          prereqs: ["Invention", "Iron Working"],
          allows: { units: ["Musketeers"] },
        },
        "Horseback Riding": {
          prereqs: [],
          allows: { units: ["Cavalry"] },
        },
        Industrialization: {
          prereqs: ["Railroad", "Banking"],
          allows: { units: ["Transport"], buildings: ["Factory"], wonders: ["Women's Suffrage"] },
        },
        Invention: {
          prereqs: ["Engineering", "Literacy"],
          allows: {},
        },
        "Iron Working": {
          prereqs: ["Bronze Working"],
          allows: { units: ["Legion"] },
        },
        "Labor Union": {
          prereqs: ["Mass Production", "Communism"],
          allows: { units: ["Mech. Inf."] },
        },
        Literacy: {
          prereqs: ["Writing", "Code of Laws"],
          allows: { wonders: ["Great Library"] },
        },
        Magnetism: {
          prereqs: ["Navigation", "Physics"],
          allows: { units: ["Frigate"] },
        },
        Mapmaking: {
          prereqs: ["Alphabet"],
          allows: { wonders: ["Lighthouse"], units: ["Trireme"] },
        },
        Masonry: {
          prereqs: [],
          allows: { buildings: ["City Walls", "Palace"], wonders: ["Pyramids", "Great Wall"] },
        },
        "Mass Production": {
          prereqs: ["Automobile", "The Corporation"],
          allows: { units: ["Submarine"], buildings: ["Mass Transit"] },
        },
        Mathematics: {
          prereqs: ["Alphabet", "Masonry"],
          allows: { units: ["Catapult"] },
        },
        Medicine: {
          prereqs: ["Philosophy", "Trade"],
          allows: { wonders: ["Shakespeare's Theatre"] },
        },
        Metallurgy: {
          prereqs: ["Gunpowder", "University"],
          allows: { units: ["Cannon"] },
        },
        Monarchy: {
          prereqs: ["Ceremonial Burial", "Code of Laws"],
          allows: { other: ["Monarchy"] },
        },
        Mysticism: {
          prereqs: ["Ceremonial Burial"],
          allows: { wonders: ["Oracle"] },
        },
        Navigation: {
          prereqs: ["Mapmaking", "Astronomy"],
          allows: { wonders: ["Magellan's Expedition"], units: ["Sail"] },
        },
        "Nuclear Fission": {
          prereqs: ["Mass Production", "Atomic Theory"],
          allows: { wonders: ["Manhattan Project"] },
        },
        "Nuclear Power": {
          prereqs: ["Nuclear Fission", "Electronics"],
          allows: { buildings: ["Nuclear Plant"] },
        },
        Philosophy: {
          prereqs: ["Mysticism", "Literacy"],
          allows: {},
        },
        Physics: {
          prereqs: ["Mathematics", "Navigation"],
          allows: {},
        },
        Plastics: {
          prereqs: ["Refining", "Space Flight"],
          allows: { wonders: ["SS Component"] },
        },
        Pottery: {
          prereqs: [],
          allows: { buildings: ["Granary"], wonders: ["Hanging Gardens"] },
        },
        Railroad: {
          prereqs: ["Steam Engine", "Bridge Building"],
          allows: { other: ["RailRoad on road squares"], wonders: ["Darwin's Voyage"] },
        },
        Recycling: {
          prereqs: ["Mass Production", "Democracy"],
          allows: { buildings: ["Recycling Center"] },
        },
        Refining: {
          prereqs: ["Chemistry", "The Corporation"],
          allows: { buildings: ["Power Plant"] },
        },
        Religion: {
          prereqs: ["Philosophy", "Writing"],
          allows: { wonders: ["Michelangelo's Chapel", "J.S. Bach's Cathedral"], buildings: ["Cathedral"] },
        },
        "The Republic": {
          prereqs: ["Code of Laws", "Literacy"],
          allows: { other: ["Republic"] },
        },
        Robotics: {
          prereqs: ["Plastics", "Computers"],
          allows: { units: ["Artillery"], buildings: ["Mfg. Plant"], wonders: ["SS Module"] },
        },
        Rocketry: {
          prereqs: ["Advanced Flight", "Electronics"],
          allows: { units: ["Nuclear unit (with Manhattan Project)"] },
        },
        "Space Flight": {
          prereqs: ["Computers", "Rocketry"],
          allows: { wonders: ["Apollo Program", "SS Structural"] },
        },
        "Steam Engine": {
          prereqs: ["Physics", "Invention"],
          allows: { units: ["Ironclad"] },
        },
        Steel: {
          prereqs: ["Metallurgy", "Industrialization"],
          allows: { units: ["Battleship"] },
        },
        Superconductor: {
          prereqs: ["Plastics", "Mass Production"],
          allows: { buildings: ["SDI Defense"] },
        },
        "Theory of Gravity": {
          prereqs: ["Astronomy", "University"],
          allows: { wonders: ["Isaac Newton's College"] },
        },
        Trade: {
          prereqs: ["Currency", "Code of Laws"],
          allows: { units: ["Caravan"] },
        },
        University: {
          prereqs: ["Mathematics", "Philosophy"],
          allows: { buildings: ["University"] },
        },
        "The Wheel": {
          prereqs: [],
          allows: { units: ["Chariot"] },
        },
        Writing: {
          prereqs: ["Alphabet"],
          allows: { buildings: ["Library"], units: ["Diplomat"] },
        },
      };

      // Build an alphabetised list of techs
      const allTechs = Object.keys(advances).sort((a, b) => a.localeCompare(b));

      const techSelect = document.getElementById("tech");
      const searchInput = document.getElementById("search");
      const chainEl = document.getElementById("chain");
      const summaryEl = document.getElementById("summary");
      const notesEl = document.getElementById("notes");

      // Helper function to categorize an item
      function categorizeItem(item) {
        // Search through all advances to find which category this item belongs to
        for (const [techName, techData] of Object.entries(advances)) {
          const allows = techData.allows || {};
          for (const [category, items] of Object.entries(allows)) {
            if (Array.isArray(items) && items.includes(item)) {
              return category;
            }
          }
        }
        return "other";
      }

      // Helper function to get allows for a technology
      function getTechnologyAllows(tech) {
        const techAllows = advances[tech]?.allows || {};
        const categorized = { units: [], buildings: [], wonders: [], other: [] };

        // Process each category in the allows data
        Object.entries(techAllows).forEach(([category, items]) => {
          if (Array.isArray(items)) {
            items.forEach((item) => {
              const itemCategory = categorizeItem(item);
              if (!categorized[itemCategory].includes(item)) {
                categorized[itemCategory].push(item);
              }
            });
          }
        });

        return categorized;
      }

      function populateOptions(list = allTechs) {
        techSelect.innerHTML = "";

        // Add default option
        const defaultOpt = document.createElement("option");
        defaultOpt.value = "";
        defaultOpt.textContent = "Please choose a technology...";
        defaultOpt.disabled = true;
        defaultOpt.selected = true;
        techSelect.appendChild(defaultOpt);

        // Add technology options
        list.forEach((t) => {
          const opt = document.createElement("option");
          opt.value = t;
          opt.textContent = t;
          techSelect.appendChild(opt);
        });
      }

      function filterOptions() {
        const q = searchInput.value.trim().toLowerCase();
        const filtered = q ? allTechs.filter((t) => t.toLowerCase().includes(q)) : allTechs;
        populateOptions(filtered);
        // Don't auto-render when filtering, let user select
      }

      // Depth-first search to gather prerequisites; returns in dependency order (prereqs first)
      function prerequisiteChain(target) {
        const seen = new Set();
        const order = [];
        function dfs(tech) {
          if (seen.has(tech)) return; // prevent cycles
          seen.add(tech);
          const reqs = advances[tech]?.prereqs || [];
          reqs.forEach(dfs); // ensure requirements come first
          order.push(tech);
        }
        // Build graph back from target; we don't include the target when reporting "needed" list
        const reqs = advances[target]?.prereqs || [];
        reqs.forEach(dfs);
        return order; // this contains only prerequisites, correctly ordered, no duplicates
      }

      function render() {
        const tech = techSelect.value;
        if (!tech) {
          // Clear the display when no technology is selected
          summaryEl.innerHTML = "";
          chainEl.innerHTML = "";
          notesEl.innerHTML = "";
          return;
        }
        const chain = prerequisiteChain(tech);

        // Summary chips
        summaryEl.innerHTML = "";
        const chip1 = document.createElement("div");
        chip1.className = "chip";
        chip1.textContent = `Target: ${tech}`;
        summaryEl.appendChild(chip1);
        const chip2 = document.createElement("div");
        chip2.className = "chip";
        chip2.textContent = `Prerequisites: ${chain.length}`;
        summaryEl.appendChild(chip2);

        // Add color legend
        const legend = document.createElement("div");
        legend.style.marginTop = "12px";
        legend.style.fontSize = "11px";
        legend.style.color = "var(--muted)";
        legend.innerHTML = `
          <div style="margin-bottom: 4px;"><strong>Allows:</strong></div>
          <div style="display: flex; gap: 8px; flex-wrap: wrap;">
            <span class="allows-chip allows-unit">Units</span>
            <span class="allows-chip allows-building">Buildings</span>
            <span class="allows-chip allows-wonder">Wonders</span>
            <span class="allows-chip allows-other">Other</span>
          </div>
        `;
        summaryEl.appendChild(legend);

        // Render the ordered list
        chainEl.innerHTML = "";
        if (!chain.length) {
          const li = document.createElement("li");
          li.innerHTML = `<strong>${tech}</strong> has no prerequisites.`;
          chainEl.appendChild(li);
        } else {
          chain.forEach((t, idx) => {
            const li = document.createElement("li");
            const deps = "";

            // Add allows information with color coding
            const techAllows = getTechnologyAllows(t);
            let allowsHtml = "";
            let allowsChips = [];

            Object.entries(techAllows).forEach(([category, items]) => {
              if (items.length > 0) {
                // Create individual chips for each item
                items.forEach((item) => {
                  // Map category names to singular form for CSS classes
                  const cssClass = category === "units" ? "unit" : category === "buildings" ? "building" : category === "wonders" ? "wonder" : "other";
                  allowsChips.push(`<span class="allows-chip allows-${cssClass}">${item}</span>`);
                });
              }
            });

            if (allowsChips.length > 0) {
              allowsHtml = allowsChips.join("");
            }

            li.innerHTML = `<strong>${t}</strong>${deps}${allowsHtml}`;
            chainEl.appendChild(li);
          });
          const final = document.createElement("li");
          final.innerHTML = `<strong class="accent">→ ${tech}</strong>`;
          chainEl.appendChild(final);
        }

        // Set up data attributes for drag and drop
        Array.from(chainEl.querySelectorAll("li")).forEach((li) => {
          // Extract the technology name from the <strong> tag, not the entire text content
          const strongElement = li.querySelector("strong");
          if (strongElement) {
            const name = strongElement.textContent.trim();
            if (advances[name]) {
              li.style.cursor = "grab";
              li.dataset.techName = name;
            }
          } else if (li.textContent.includes("→")) {
            // This is the target tech arrow - make it non-draggable
            li.classList.add("no-drag");
            li.style.cursor = "default";
          }
        });

        // Initialize SortableJS after rendering
        initializeSortable();

        // Set initial validation status
        updateValidationStatus();
      }

      // Save/Load functionality
      const STORAGE_KEY = "civ1_tech_lists";

      function getSavedLists() {
        try {
          const saved = localStorage.getItem(STORAGE_KEY);
          return saved ? JSON.parse(saved) : {};
        } catch (e) {
          console.error("Error loading saved lists:", e);
          return {};
        }
      }

      function saveLists(lists) {
        try {
          localStorage.setItem(STORAGE_KEY, JSON.stringify(lists));
        } catch (e) {
          console.error("Error saving lists:", e);
        }
      }

      function saveCurrentListFromTop() {
        const nameInput = document.getElementById("saveNameTop");
        const name = nameInput.value.trim();

        if (!name) {
          alert("Please enter a name for your list");
          return;
        }

        const currentTech = techSelect.value;
        if (!currentTech) {
          alert("Please select a technology first");
          return;
        }

        const chain = prerequisiteChain(currentTech);
        const savedLists = getSavedLists();

        savedLists[name] = {
          target: currentTech,
          prerequisites: chain,
          timestamp: Date.now(),
        };

        saveLists(savedLists);
        nameInput.value = "";
        renderSavedLists();

        // Show success message
        const saveBtn = document.getElementById("saveBtnTop");
        const originalText = saveBtn.textContent;
        saveBtn.textContent = "Saved!";
        saveBtn.style.background = "#34d399";
        setTimeout(() => {
          saveBtn.textContent = originalText;
          saveBtn.style.background = "var(--accent)";
        }, 1500);
      }

      function loadList(name) {
        const savedLists = getSavedLists();
        const list = savedLists[name];

        if (list && list.target) {
          // Clear any search filter first
          const searchInput = document.getElementById("search");
          searchInput.value = "";

          // Repopulate the dropdown with all technologies
          populateOptions();

          // Find and select the target technology
          for (let i = 0; i < techSelect.options.length; i++) {
            if (techSelect.options[i].value === list.target) {
              techSelect.selectedIndex = i;
              break;
            }
          }

          // Render the selected technology
          render();

          // Show a brief success message
          const loadBtn = event.target;
          const originalText = loadBtn.textContent;
          loadBtn.textContent = "Loaded!";
          loadBtn.style.background = "var(--accent)";
          loadBtn.style.color = "#000";
          setTimeout(() => {
            loadBtn.textContent = originalText;
            loadBtn.style.background = "transparent";
            loadBtn.style.color = "var(--accent)";
          }, 1000);
        }
      }

      function deleteList(name) {
        if (confirm(`Delete "${name}"?`)) {
          const savedLists = getSavedLists();
          delete savedLists[name];
          saveLists(savedLists);
          renderSavedLists();
        }
      }

      function renameList(oldName) {
        const newName = prompt("Enter new name:", oldName);
        if (newName && newName.trim() && newName !== oldName) {
          const savedLists = getSavedLists();
          if (savedLists[newName]) {
            alert("A list with that name already exists");
            return;
          }

          savedLists[newName] = savedLists[oldName];
          delete savedLists[oldName];
          saveLists(savedLists);
          renderSavedLists();
        }
      }

      function renderSavedLists() {
        const container = document.getElementById("savedLists");
        const savedLists = getSavedLists();
        const listNames = Object.keys(savedLists).sort();

        if (listNames.length === 0) {
          container.innerHTML = '<div style="color: var(--muted); font-size: 12px; text-align: center; padding: 12px;">No saved lists yet</div>';
          return;
        }

        container.innerHTML = listNames
          .map((name) => {
            const list = savedLists[name];
            const date = new Date(list.timestamp).toLocaleDateString();
            return `
            <div style="display: flex; align-items: center; gap: 8px; padding: 8px; background: #0f172a; border: 1px solid rgba(255, 255, 255, 0.08); border-radius: 8px; margin-bottom: 8px;">
              <div style="flex: 1; min-width: 0;">
                <div style="font-weight: 500; font-size: 13px; color: var(--text); margin-bottom: 2px;">${name}</div>
                <div style="font-size: 11px; color: var(--muted);">
                  ${list.target} (${list.prerequisites.length} prereqs) • ${date}
                </div>
              </div>
              <button onclick="loadList('${name}')" style="padding: 4px 8px; border-radius: 4px; border: 1px solid var(--accent); background: transparent; color: var(--accent); font-size: 11px; cursor: pointer;">Load</button>
              <button onclick="renameList('${name}')" style="padding: 4px 8px; border-radius: 4px; border: 1px solid var(--muted); background: transparent; color: var(--muted); font-size: 11px; cursor: pointer;">Rename</button>
              <button onclick="deleteList('${name}')" style="padding: 4px 8px; border-radius: 4px; border: 1px solid #f87171; background: transparent; color: #f87171; font-size: 11px; cursor: pointer;">Delete</button>
            </div>
          `;
          })
          .join("");
      }

      // Add enter key support for save input
      document.addEventListener("DOMContentLoaded", function () {
        const saveNameTopInput = document.getElementById("saveNameTop");

        saveNameTopInput.addEventListener("keypress", function (e) {
          if (e.key === "Enter") {
            saveCurrentListFromTop();
          }
        });
      });

      // Drag and drop functionality using SortableJS
      let sortableInstance = null;

      function initializeSortable() {
        const chainEl = document.getElementById("chain");
        if (sortableInstance) {
          sortableInstance.destroy();
        }

        sortableInstance = new Sortable(chainEl, {
          animation: 150,
          ghostClass: "sortable-ghost",
          chosenClass: "sortable-chosen",
          dragClass: "sortable-drag",
          filter: ".no-drag", // Prevent dragging the target tech arrow
          onEnd: function (evt) {
            // Auto-reorder dependent technologies after moving a prerequisite
            autoReorderDependents(evt);
            // Update validation status after reordering
            updateValidationStatus();
          },
        });
      }

      function autoReorderDependents(evt) {
        if (!evt || !evt.item) return;

        const currentOrder = getCurrentOrder();
        if (currentOrder.length === 0) return;

        console.log("Starting systematic dependency validation...");

        // Systematically validate and fix the entire list
        const newOrder = validateAndFixDependencies(currentOrder);

        if (JSON.stringify(newOrder) !== JSON.stringify(currentOrder)) {
          console.log("Auto-reordering to fix dependency violations:", {
            oldOrder: currentOrder,
            newOrder,
          });
          renderCustomOrder(newOrder);
        } else {
          console.log("No dependency violations found, order is valid");
        }
      }

      function validateAndFixDependencies(order) {
        let currentOrder = [...order];
        let hasChanges = true;
        let iteration = 0;
        const maxIterations = 10; // Prevent infinite loops

        while (hasChanges && iteration < maxIterations) {
          hasChanges = false;
          iteration++;
          console.log(`Iteration ${iteration}: validating dependencies...`);

          // Go through the list from start to finish
          for (let i = 0; i < currentOrder.length; i++) {
            const tech = currentOrder[i];
            const prereqs = advances[tech]?.prereqs || [];

            // Check if all prerequisites come before this technology
            const missingPrereqs = [];
            for (const prereq of prereqs) {
              const prereqIndex = currentOrder.indexOf(prereq);
              if (prereqIndex > i) {
                // Prerequisite comes after the technology that needs it
                missingPrereqs.push(prereq);
              }
            }

            if (missingPrereqs.length > 0) {
              console.log(`Violation found: ${tech} needs ${missingPrereqs.join(", ")} to come first`);

              // Move this technology to just after its last prerequisite
              currentOrder = moveTechAfterLastPrereq(currentOrder, tech, missingPrereqs);
              hasChanges = true;

              // Start over from the beginning since we made changes
              break;
            }
          }
        }

        if (iteration >= maxIterations) {
          console.warn("Maximum iterations reached, dependency validation may be incomplete");
        }

        return currentOrder;
      }

      function moveTechAfterLastPrereq(order, tech, missingPrereqs) {
        // Find the position of the last prerequisite
        let lastPrereqIndex = -1;
        for (const prereq of missingPrereqs) {
          const prereqIndex = order.indexOf(prereq);
          if (prereqIndex > lastPrereqIndex) {
            lastPrereqIndex = prereqIndex;
          }
        }

        if (lastPrereqIndex === -1) return order; // Shouldn't happen

        const techIndex = order.indexOf(tech);
        const newOrder = [...order];

        // Remove the technology from its current position
        newOrder.splice(techIndex, 1);

        // Insert it after the last prerequisite
        // Note: After removing the tech, the indices shift, so we need to adjust
        const adjustedLastPrereqIndex = lastPrereqIndex > techIndex ? lastPrereqIndex - 1 : lastPrereqIndex;
        newOrder.splice(adjustedLastPrereqIndex + 1, 0, tech);

        console.log(`Moved ${tech} from position ${techIndex} to position ${adjustedLastPrereqIndex + 1} (after ${order[lastPrereqIndex]})`);

        return newOrder;
      }

      function orderDependentsByDependency(dependents) {
        // Sort dependents so that prerequisites come before their dependents
        const sorted = [];
        const added = new Set();

        function addWithPrereqs(tech) {
          if (added.has(tech)) return;

          const prereqs = advances[tech]?.prereqs || [];
          for (const prereq of prereqs) {
            if (dependents.includes(prereq)) {
              addWithPrereqs(prereq);
            }
          }

          sorted.push(tech);
          added.add(tech);
        }

        for (const tech of dependents) {
          addWithPrereqs(tech);
        }

        return sorted;
      }

      function updateValidationStatus() {
        const currentTech = techSelect.value;
        if (!currentTech) return;

        const currentOrder = getCurrentOrder();
        const targetPrereqs = prerequisiteChain(currentTech);
        const missingPrereqs = targetPrereqs.filter((prereq) => !currentOrder.includes(prereq));

        // Check for prerequisite ordering issues
        const orderingIssues = [];
        for (let i = 0; i < currentOrder.length; i++) {
          const tech = currentOrder[i];
          const prereqs = advances[tech]?.prereqs || [];

          for (const prereq of prereqs) {
            const prereqIndex = currentOrder.indexOf(prereq);
            if (prereqIndex > i) {
              // Prerequisite comes after the technology that needs it
              orderingIssues.push(`${tech} requires ${prereq} to come first`);
            }
          }
        }

        console.log("Validation debug:", {
          currentOrder,
          targetPrereqs,
          missingPrereqs,
          orderingIssues,
          tech: currentTech,
        });

        if (missingPrereqs.length > 0) {
          notesEl.innerHTML = `<span style="color: #fbbf24;">⚠️ Warning: Missing prerequisites: ${missingPrereqs.join(", ")}. Drag them back into the list or use Reset Order.</span>`;
        } else if (orderingIssues.length > 0) {
          notesEl.innerHTML = `<span style="color: #fbbf24;">⚠️ Warning: Prerequisite order issues: ${orderingIssues.join(", ")}. Reorder technologies or use Reset Order.</span>`;
        } else {
          notesEl.innerHTML = `✅ Valid research path.`;
        }
      }

      function getCurrentOrder() {
        const listItems = document.querySelectorAll("#chain li:not(.no-drag)");
        console.log("getCurrentOrder debug:", {
          totalItems: listItems.length,
          items: Array.from(listItems).map((item) => ({
            text: item.textContent,
            dataset: item.dataset.techName,
            html: item.outerHTML,
          })),
        });

        return Array.from(listItems)
          .map((item) => {
            // Try to get from dataset first, fall back to strong tag extraction
            if (item.dataset.techName) {
              return item.dataset.techName;
            }
            // Extract from strong tag (same logic as in render function)
            const strongElement = item.querySelector("strong");
            if (strongElement) {
              const extracted = strongElement.textContent.trim();
              console.log("Extracted tech name:", extracted, "from strong tag");
              return extracted;
            }
            return null;
          })
          .filter((name) => name && advances[name]); // Only include valid technology names
      }

      function ensurePrerequisiteIntegrity(order) {
        const currentTech = techSelect.value;
        if (!currentTech) return order;

        // Get all prerequisites needed for the target technology
        const targetPrereqs = prerequisiteChain(currentTech);
        const targetPrereqsSet = new Set(targetPrereqs);

        const validatedOrder = [];
        const added = new Set();

        // First, ensure all target prerequisites are included
        for (const prereq of targetPrereqs) {
          if (!added.has(prereq)) {
            validatedOrder.push(prereq);
            added.add(prereq);
          }
        }

        // Then add any additional technologies from the custom order
        for (const tech of order) {
          if (!added.has(tech)) {
            validatedOrder.push(tech);
            added.add(tech);
          }
        }

        return validatedOrder;
      }

      function renderCustomOrder(order) {
        const chainEl = document.getElementById("chain");
        chainEl.innerHTML = "";

        order.forEach((tech, index) => {
          const li = document.createElement("li");
          li.dataset.techName = tech;
          li.style.cursor = "grab";

          // Add allows information with color coding
          const techAllows = getTechnologyAllows(tech);
          let allowsHtml = "";
          let allowsChips = [];

          Object.entries(techAllows).forEach(([category, items]) => {
            if (items.length > 0) {
              items.forEach((item) => {
                const cssClass = category === "units" ? "unit" : category === "buildings" ? "building" : category === "wonders" ? "wonder" : "other";
                allowsChips.push(`<span class="allows-chip allows-${cssClass}">${item}</span>`);
              });
            }
          });

          if (allowsChips.length > 0) {
            allowsHtml = allowsChips.join("");
          }

          li.innerHTML = `<strong>${tech}</strong>${allowsHtml}`;

          chainEl.appendChild(li);
        });

        // Add the target tech at the end
        const currentTech = techSelect.value;
        if (currentTech && !order.includes(currentTech)) {
          const final = document.createElement("li");
          final.innerHTML = `<strong class="accent">→ ${currentTech}</strong>`;
          final.style.cursor = "default";
          final.classList.add("no-drag");
          chainEl.appendChild(final);
        }

        // Re-initialize SortableJS
        initializeSortable();
      }

      function resetToOriginalOrder() {
        const currentTech = techSelect.value;
        if (currentTech) {
          render(); // This will restore the original prerequisite order
        }
      }

      // Update the save function to include custom order
      function saveCurrentListFromTop() {
        const nameInput = document.getElementById("saveNameTop");
        const name = nameInput.value.trim();

        if (!name) {
          alert("Please enter a name for your list");
          return;
        }

        const currentTech = techSelect.value;
        if (!currentTech) {
          alert("Please select a technology first");
          return;
        }

        const chain = prerequisiteChain(currentTech);
        const customOrder = getCurrentOrder();

        // Validate the custom order and show warning if invalid
        const targetPrereqs = prerequisiteChain(currentTech);
        const missingPrereqs = targetPrereqs.filter((prereq) => !customOrder.includes(prereq));

        if (missingPrereqs.length > 0) {
          const warning = `Warning: Your custom order is missing some prerequisites: ${missingPrereqs.join(", ")}. These will be automatically added when you research this path.`;
          if (!confirm(warning + "\n\nDo you want to save anyway?")) {
            return;
          }
        }

        const savedLists = getSavedLists();

        savedLists[name] = {
          target: currentTech,
          prerequisites: chain,
          customOrder: customOrder.length > 0 ? customOrder : null,
          timestamp: Date.now(),
        };

        saveLists(savedLists);
        nameInput.value = "";
        renderSavedLists();

        // Show success message
        const saveBtn = document.getElementById("saveBtnTop");
        const originalText = saveBtn.textContent;
        saveBtn.textContent = "Saved!";
        saveBtn.style.background = "#34d399";
        setTimeout(() => {
          saveBtn.textContent = originalText;
          saveBtn.style.background = "var(--accent)";
        }, 1500);
      }

      // Update the load function to restore custom order
      function loadList(name) {
        const savedLists = getSavedLists();
        const list = savedLists[name];

        if (list && list.target) {
          // Clear any search filter first
          const searchInput = document.getElementById("search");
          searchInput.value = "";

          // Repopulate the dropdown with all technologies
          populateOptions();

          // Find and select the target technology
          for (let i = 0; i < techSelect.options.length; i++) {
            if (techSelect.options[i].value === list.target) {
              techSelect.selectedIndex = i;
              break;
            }
          }

          // Render the selected technology
          render();

          // Restore custom order if it exists
          if (list.customOrder && list.customOrder.length > 0) {
            setTimeout(() => {
              renderCustomOrder(list.customOrder);
            }, 100);
          }

          // Show a brief success message
          const loadBtn = event.target;
          const originalText = loadBtn.textContent;
          loadBtn.textContent = "Loaded!";
          loadBtn.style.background = "var(--accent)";
          loadBtn.style.color = "#000";
          setTimeout(() => {
            loadBtn.textContent = originalText;
            loadBtn.style.background = "transparent";
            loadBtn.style.color = "var(--accent)";
          }, 1000);
        }
      }

      // Initialise
      populateOptions();
      render();
      renderSavedLists();
    </script>
  </body>
</html>
